<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>{{ month_name }} {{ year }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<div class="d-flex">
    <!-- –õ–µ–≤–æ–µ –º–µ–Ω—é -->
    <aside class="sidebar p-3">
        <h4 class="mb-4"><span style="color: #0d6efd;">Find</span><strong>Time</strong></h4>

        <div class="mb-3">
            <button class="btn btn-primary w-100 mb-2"><i class="bi bi-plus-circle me-1"></i> –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</button>
            <button class="btn btn-outline-secondary w-100"><i class="bi bi-plus-square me-1"></i> –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
        </div>

        <h6 class="text-muted mt-4">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä–∏</h6>
        <form method="get" id="calendarFilterForm" class="mb-3">
          <input type="hidden" name="month" value="{{ month }}">
          <input type="hidden" name="year" value="{{ year }}">
          <ul class="list-unstyled small">
            {% for cid, cname in calendars.items() %}
            <li class="d-flex justify-content-between align-items-center">
              <label class="d-flex align-items-center gap-1">
                <input type="checkbox" name="calendar"
                       value="{{ cid }}"
                       onchange="document.getElementById('calendarFilterForm').submit();"
                       {% if cid in selected_calendars %}checked{% endif %}>
                {{ cname }}
              </label>
              <button type="button" class="btn btn-sm text-secondary p-0"
                      onclick="openEditCalendarModal('{{ cid }}', '{{ cname }}', '{{ calendar_colors[cid] }}')"
                      title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                <i class="bi bi-three-dots-vertical"></i>
              </button>
            </li>
            {% endfor %}
          </ul>
          <button type="button" class="btn btn-sm btn-outline-primary w-100" onclick="showCreateCalendarModal()">
            + –î–æ–±–∞–≤–∏—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å
          </button>
        </form>

        <h6 class="text-muted mt-4">üëÅ –í–∏–¥</h6>
        <ul class="list-unstyled small">
            <li>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</li>
            <li>–ú–∞—Ç—Ä–∏—Ü–∞ –≠–π–∑–µ–Ω—Ö–∞—É—ç—Ä–∞</li>
            <li>–î–∏–∞–≥—Ä–∞–º–º–∞ –ì–∞–Ω—Ç–∞</li>
            <li>–î–æ—Å–∫–∞ ¬´Kanban¬ª</li>
        </ul>

        <h6 class="text-muted mt-4">üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h6>
        <ul class="list-unstyled small">
            <li>–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—Ç–µ–ª—å–Ω—ã–π —á–µ–ª–æ–≤–µ–∫ <br><small class="text-muted">78 / 100</small></li>
            <li>–°–æ–±—ã—Ç–∏–π–Ω–æ—Å—Ç—å –ø—Ä–µ–≤—ã—Å—à–µ <br><small class="text-muted">320 / 1000</small></li>
        </ul>
    </aside>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <main class="flex-grow-1 p-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <a href="{{ url_for('index', month=current_date.month, year=current_date.year, calendar=selected_calendars) }}"
                   class="btn btn-outline-secondary btn-sm me-2">
                   –°–µ–≥–æ–¥–Ω—è
                </a>
                <strong class="fs-4">{{ month_name }} {{ year }}</strong>
            </div>
            <div class="d-flex align-items-center gap-2">
                <a href="{{ url_for('index', month=(month - 1 if month > 1 else 12),
                    year=(year - 1 if month == 1 else year),
                    calendar=selected_calendars) }}"
                    class="btn btn-light border"><i class="bi bi-arrow-left"></i></a>
                <a href="{{ url_for('index', month=(month + 1 if month > 1 else 12),
                    year=(year - 1 if month == 1 else year),
                    calendar=selected_calendars) }}"
                    class="btn btn-light border"><i class="bi bi-arrow-right"></i></a>

                <!-- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π -->
                <form method="get" class="d-flex align-items-center gap-2">
                    <input type="hidden" name="month" value="{{ month }}">
                    <input type="hidden" name="year" value="{{ year }}">
                    <select name="calendar" class="form-select form-select-sm w-auto" onchange="this.form.submit()">
                        {% for cid, cname in calendars.items() %}
                            <option value="{{ cid }}" {% if cid == active_calendar %}selected{% endif %}>{{ cname }}</option>
                        {% endfor %}
                    </select>
                </form>

                <a href="/export.ics" class="btn btn-outline-primary btn-sm"><i class="bi bi-download"></i> –≠–∫—Å–ø–æ—Ä—Ç</a>
            </div>
        </div>

        <!-- –°–µ—Ç–∫–∞ –¥–Ω–µ–π -->
        <div class="calendar-wrapper position-relative">
            <div class="calendar-grid">
                {% for day in ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'] %}
                    <div class="calendar-header">{{ day }}</div>
                {% endfor %}

                {% for day in days %}
                    <div class="calendar-cell
                        {% if day.month != month %}dimmed{% endif %}
                        {% if day == current_date %}today{% endif %}"
                        data-date="{{ day.strftime('%Y-%m-%d') }}"
                        ondblclick="openModal(this)">
                        <div class="date-number">{{ day.day }}</div>
                        <div class="event-blocks">
                            {% for event in events[day.strftime('%Y-%m-%d')] %}
                                {% set start = event.start.split('T')[0] %}
                                {% set end = event.end.split('T')[0] %}
                                {% if start == end %}
                                    <div class="event-item"
                                        style="background-color: {{ calendar_colors.get(event.calendar_id, '#0d6efd') }}20;
                                            border-left: 3px solid {{ calendar_colors.get(event.calendar_id, '#0d6efd') }};">
                                        {{ event.title }}
                                    </div>
                                {% endif %}
                            {% endfor %}

                            {# –ú–Ω–æ–≥–æ–¥–Ω–µ–≤–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è: —Ä–∏—Å—É–µ–º —Ç–æ–ª—å–∫–æ –≤ –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å #}
                              {% for event in multiday_events %}
                                {% set start_date = event['start'].split('T')[0] %}
                                {% if start_date == day.strftime('%Y-%m-%d') %}
                                  <div class="multiday-line-inside"
                                       style="width: calc({{ event.span }} * 100% / 7);
                                              background-color: {{ calendar_colors.get(event.calendar_id, '#0d6efd') }}">
                                    {{ event.title }}
                                  </div>
                                {% endif %}
                              {% endfor %}
                        </div>
                    </div>
                {% endfor %}

<!--                {% for event in multiday_events %}-->
<!--                    <div class="multiday-line"-->
<!--                        style="grid-row: {{ event.grid_row }};-->
<!--                               grid-column: {{ event.grid_start }} / span {{ event.span }};-->
<!--                               background-color: {{ calendar_colors.get(event.calendar_id, '#0d6efd') }};">-->
<!--                        {{ event.title }}-->
<!--                    </div>-->
<!--                {% endfor %}-->

            </div> <!-- .calendar-grid -->
        </div> <!-- .calendar-wrapper -->
    </main>
</div> <!-- .d-flex -->


<!-- –ú–æ–¥–∞–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" action="/add" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–°–æ–∑–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
          <input type="text" class="form-control" name="title" required>
        </div>
        <div class="mb-3">
          <label class="form-label">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</label>
          <select name="calendar" class="form-select" required>
            {% for cid, cname in calendars.items() %}
              <option value="{{ cid }}" {% if cid == active_calendar %}selected{% endif %}>{{ cname }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞</label>
          <input type="datetime-local" class="form-control" name="start_datetime" required>
        </div>
        <div class="mb-3">
          <label class="form-label">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
          <input type="datetime-local" class="form-control" name="end_datetime" required>
        </div>
        <div class="mb-3">
          <label class="form-label">–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</label>
          <input type="text" class="form-control" name="location">
        </div>
        <div class="mb-3">
          <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <textarea class="form-control" name="description" rows="2"></textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">–ù–∞–ø–æ–º–Ω–∏—Ç—å –∑–∞</label>
          <select class="form-select" name="reminder">
            <option value="">–ë–µ–∑ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</option>
            <option value="5">5 –º–∏–Ω—É—Ç</option>
            <option value="10">10 –º–∏–Ω—É—Ç</option>
            <option value="30">30 –º–∏–Ω—É—Ç</option>
            <option value="60">1 —á–∞—Å</option>
            <option value="1440">1 –¥–µ–Ω—å</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">–°—Å—ã–ª–∫–∞ –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</label>
          <input type="url" class="form-control" name="url" placeholder="https://...">
        </div>

        <div class="mb-3">
          <label class="form-label">–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ</label>
          <select class="form-select" name="repeat">
            <option value="none">–ù–µ –ø–æ–≤—Ç–æ—Ä—è—Ç—å</option>
            <option value="daily">–ï–∂–µ–¥–Ω–µ–≤–Ω–æ</option>
            <option value="weekly">–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ</option>
            <option value="monthly">–ï–∂–µ–º–µ—Å—è—á–Ω–æ</option>
            <option value="yearly">–ï–∂–µ–≥–æ–¥–Ω–æ</option>
          </select>
        </div>

      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </form>
  </div>
</div>


<!-- –ú–æ–¥–∞–ª–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
<div class="modal fade" id="editEventModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" method="post" action="/edit" id="editEventForm">
      <div class="modal-header">
        <h5 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ</h5>
      </div>
      <div class="modal-body">
        <input type="hidden" name="event_date" id="editDateInput">
        <input type="hidden" name="event_index" id="editIndexInput">
        <input type="hidden" name="calendar" value="{{ active_calendar }}">
        <div class="mb-3">
          <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
          <input type="text" class="form-control" name="title" id="editTitleInput" required>
        </div>
        <div class="mb-3">
          <label class="form-label">–í—Ä–µ–º—è</label>
          <input type="time" class="form-control" name="time" id="editTimeInput" required>
        </div>
      </div>
      <div class="modal-footer d-flex justify-content-between w-100">
        <button type="button" class="btn btn-secondary" onclick="closeEditModal()">–û—Ç–º–µ–Ω–∞</button>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-outline-danger" onclick="triggerDeleteFromEditModal()">–£–¥–∞–ª–∏—Ç—å</button>
            <button type="submit" class="btn btn-success" form="editEventForm">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form class="modal-content" method="post" action="/delete" id="deleteForm">
      <div class="modal-header">
        <h5 class="modal-title">–£–¥–∞–ª–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ?</h5>
      </div>
      <input type="hidden" name="event_date" id="deleteDateInput">
      <input type="hidden" name="event_index" id="deleteIndexInput">
      <input type="hidden" name="calendar" value="{{ active_calendar }}">
      <div class="modal-footer">
        <button type="submit" class="btn btn-danger">–£–¥–∞–ª–∏—Ç—å</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </form>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è -->
<div class="modal fade" id="createCalendarModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" action="/create_calendar" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–°–æ–∑–¥–∞—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è</label>
          <input type="text" class="form-control" name="calendar_name" required>
        </div>
        <div class="mb-3">
          <label class="form-label">–¶–≤–µ—Ç (hex)</label>
          <input type="color" class="form-control form-control-color" name="calendar_color" value="#0d6efd">
        </div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-success">–°–æ–∑–¥–∞—Ç—å</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </form>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è -->
<div class="modal fade" id="editCalendarModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" action="/edit_calendar" class="modal-content">
      <div id="calendarSelectionHiddenInputs"></div>
      <div class="modal-header">
        <h5 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="calendar_id" id="editCalendarId">
        <div class="mb-3">
          <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
          <input type="text" class="form-control" name="calendar_name" id="editCalendarName" required>
        </div>
        <div class="mb-3">
          <label class="form-label">–¶–≤–µ—Ç</label>
          <input type="color" class="form-control form-control-color" name="calendar_color" id="editCalendarColor">
        </div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </form>
  </div>
</div>


<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function openModal(cell) {
         const date = cell.getAttribute('data-date');

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ start_datetime —Å 09:00 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        const startField = document.querySelector('input[name="start_datetime"]');
        const endField = document.querySelector('input[name="end_datetime"]');

        if (startField && endField) {
            const now = new Date();
            const defaultTime = "09:00";
            startField.value = `${date}T${defaultTime}`;
            endField.value = `${date}T10:00`;
        }

        new bootstrap.Modal(document.getElementById('eventModal')).show();
    }

    function triggerEditModal(date, index, title, time) {
        document.getElementById('editDateInput').value = date;
        document.getElementById('editIndexInput').value = index;
        document.getElementById('editTitleInput').value = title;
        document.getElementById('editTimeInput').value = time;
        new bootstrap.Modal(document.getElementById('editEventModal')).show();
    }

    function closeEditModal() {
        const editModal = bootstrap.Modal.getInstance(document.getElementById('editEventModal'));
        if (editModal) editModal.hide();
    }

    function triggerDeleteModal(date, index) {
        document.getElementById('deleteDateInput').value = date;
        document.getElementById('deleteIndexInput').value = index;
        new bootstrap.Modal(document.getElementById('confirmDeleteModal')).show();
    }

    function triggerDeleteFromEditModal() {
        const date = document.getElementById('editDateInput').value;
        const index = document.getElementById('editIndexInput').value;
        closeEditModal();
        setTimeout(() => triggerDeleteModal(date, index), 300);
    }
    function showCreateCalendarModal() {
        new bootstrap.Modal(document.getElementById('createCalendarModal')).show();
    }
    function openEditCalendarModal(id, name, color) {
        document.getElementById('editCalendarId').value = id;
        document.getElementById('editCalendarName').value = name;
        document.getElementById('editCalendarColor').value = color;

        // –î–æ–±–∞–≤–∏–º —Å–∫—Ä—ã—Ç—ã–µ inputs –¥–ª—è –≤—Å–µ—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π
        const container = document.getElementById('calendarSelectionHiddenInputs');
        container.innerHTML = '';

        const checkedBoxes = document.querySelectorAll('input[name="calendar"]:checked');
        checkedBoxes.forEach(cb => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'calendar';
            input.value = cb.value;
            container.appendChild(input);
        });

        new bootstrap.Modal(document.getElementById('editCalendarModal')).show();
    }
</script>
</body>
</html>
